library(data.table)
library(dplyr)
library(Hmisc)

setwd("~/OneDrive - IESEG/Semestre_2/Statistics and Machine Learning for MKT/Kaggle/data")
train<-readRDS(file = "train.rds")
train1<-train

# Function for reducing levels in factor variable
# Inputs: fvar: factor variable, perc: % min to be considered as a relevant level.
# Output: fvar updated replacing low freq level with "LFL".
redu_levels<- function(fvar,perc=0.01){
  fvar<-as.factor(fvar)
  # Condition level usage less that perc%
  condition<-table(fvar)/length(fvar) < perc
  # Creating the level LFL
  levels(fvar)<-c(levels(fvar),"LFL")
  lfl<-names(which(condition))
  # Replacing Low Frequency Levels with LFL
  fvar[fvar %in% lfl] <-"LFL"
  # Dropping levels with freq zero
  fvar<-droplevels(fvar)
  # Retuning the new level distribution in %
  flevels<-round(table(fvar)/length(fvar)*100,3)
  print(flevels)
  return(fvar)
}

# Function to calculate the most frequent category
# Input: vector x (categorical)
# Output: most popular category name

most_frequent_category <- function(x) {
  categories <- table(x)
  return(names(categories[which.max(categories)]))
}

# Running the function for 27-1 variables
train1[,2:27]<-as.data.frame(lapply(train1[,2:27],redu_levels,perc=0.01))

# Verifying
lapply(train1[,2:27],function(x) round(table(x)/length(x)*100,3))

# Comparing before/after levels
before<-sapply(train[,2:27], function(x) length(levels(as.factor(x))))
after<-sapply(train1[,2:27], function(x) length(levels(x)))
cbind(before,after)

# $AvSigVersion -> Keep
# x
# 1.263.48.0 1.273.1420.0 1.275.1140.0  1.275.727.0          LFL 
# 1.099        1.147        1.090        1.036       95.628
# 
# $IsBeta -> Delete
# x
# 0    LFL 
# 99.999  0.001 


# $DefaultBrowsersIdentifier -> Delete
# x
# LFL 
# 4.858 


# $CountryIdentifier -> Keep
# x
# 9     29     35     41     43     44     51     60     66     68     88     89     93     97    107    141    142    149    155 
# 1.935  3.901  1.570  1.799  4.452  2.048  1.793  2.600  2.338  1.795  1.010  2.248  3.179  2.188  1.894  3.737  1.479  1.452  1.242 
# 158    159    160    164    171    173    195    201    203    205    207    214    LFL 
# 2.071  1.027  1.482  1.217  3.145  1.055  1.476  2.473  1.772  1.314  2.372  2.144 35.794 
# 
# $CityIdentifier -> Delete
# x
# 130775    LFL 
# 1.063 95.290

# Identifying columns to delete (6,9,15)
which(colnames(train1)=="IsBeta")
which(colnames(train1)=="DefaultBrowsersIdentifier")
which(colnames(train1)=="CityIdentifier")

# Selecting final columns
mydata<-train1[,c(1:5,7,8,10:14,16:27)]

# Checking NA values
NAVal<-sapply(mydata[,2:23], function(x) sum(is.na(x)))

mydata$RtpStateBitfield <- impute(mydata$RtpStateBitfield,most_frequent_category(mydata$RtpStateBitfield))
mydata$AVProductStatesIdentifier <- impute(mydata$AVProductStatesIdentifier,most_frequent_category(mydata$AVProductStatesIdentifier))
mydata$AVProductsInstalled <- impute(mydata$AVProductsInstalled,most_frequent_category(mydata$AVProductsInstalled))
mydata$AVProductsEnabled <- impute(mydata$AVProductsEnabled,most_frequent_category(mydata$AVProductsEnabled))
mydata$OrganizationIdentifier <- impute(mydata$OrganizationIdentifier,most_frequent_category(mydata$OrganizationIdentifier))
mydata$GeoNameIdentifier <- impute(mydata$GeoNameIdentifier,most_frequent_category(mydata$GeoNameIdentifier))
mydata$IsProtected <- impute(mydata$IsProtected,most_frequent_category(mydata$IsProtected))

# Saving data
saveRDS(mydata, file = "mydata.rds")

#mydata<-readRDS(file = "mydata.rds")

#basetable<-readRDS(file = "basetable.rds")

# Dividing vars with more than 3 levels
sort(sapply(mydata[,2:24],function(x) length(levels(x))),decreasing=TRUE)
gt3levels<-which(sapply(mydata[,1:24],function(x) length(levels(x)))>3)
# gt3levels 
# le3levels
mydata_GT3_class<-select(mydata,MachineIdentifier,gt3levels)
mydata_LE3_class<-select(mydata,-gt3levels)


sort(sapply(mydata_GT3_class,function(x) length(levels(x))),decreasing=TRUE)
sort(sapply(mydata_LE3_class,function(x) length(levels(x))),decreasing=TRUE)

saveRDS(mydata_GT3_class, file = "mydata_GT3_class.rds")
saveRDS(mydata_LE3_class, file = "mydata_LE3_class.rds")
